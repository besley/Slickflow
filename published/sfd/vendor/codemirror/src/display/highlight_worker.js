import{getContextBefore,highlightLine,processLine}from"../line/highlight.js";import{copyState}from"../modes.js";import{bind}from"../util/misc.js";import{runInOp}from"./operations.js";import{regLineChange}from"./view_tracking.js";export function startWorker(e,t){e.doc.highlightFrontier<e.display.viewTo&&e.state.highlight.set(t,bind(highlightWorker,e))}function highlightWorker(e){let t=e.doc;if(t.highlightFrontier>=e.display.viewTo)return;let i=+new Date+e.options.workTime,s=getContextBefore(e,t.highlightFrontier),l=[];t.iter(s.line,Math.min(t.first+t.size,e.display.viewTo+500),(n=>{if(s.line>=e.display.viewFrom){let i=n.styles,r=n.text.length>e.options.maxHighlightLength?copyState(t.mode,s.state):null,o=highlightLine(e,n,s,!0);r&&(s.state=r),n.styles=o.styles;let h=n.styleClasses,g=o.classes;g?n.styleClasses=g:h&&(n.styleClasses=null);let a=!i||i.length!=n.styles.length||h!=g&&(!h||!g||h.bgClass!=g.bgClass||h.textClass!=g.textClass);for(let e=0;!a&&e<i.length;++e)a=i[e]!=n.styles[e];a&&l.push(s.line),n.stateAfter=s.save(),s.nextLine()}else n.text.length<=e.options.maxHighlightLength&&processLine(e,n.text,s),n.stateAfter=s.line%5==0?s.save():null,s.nextLine();if(+new Date>i)return startWorker(e,e.options.workDelay),!0})),t.highlightFrontier=s.line,t.modeFrontier=Math.max(t.modeFrontier,s.line),l.length&&runInOp(e,(()=>{for(let t=0;t<l.length;t++)regLineChange(e,l[t],"text")}))}