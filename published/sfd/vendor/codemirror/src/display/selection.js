import{Pos}from"../line/pos.js";import{visualLine}from"../line/spans.js";import{getLine}from"../line/utils_line.js";import{charCoords,cursorCoords,displayWidth,paddingH,wrappedLineExtentChar}from"../measurement/position_measurement.js";import{getOrder,iterateBidiSections}from"../util/bidi.js";import{elt}from"../util/dom.js";import{onBlur}from"./focus.js";export function updateSelection(t){t.display.input.showSelection(t.display.input.prepareSelection())}export function prepareSelection(t,e=!0){let o=t.doc,r={},i=r.cursors=document.createDocumentFragment(),l=r.selection=document.createDocumentFragment(),n=t.options.$customCursor;n&&(e=!0);for(let r=0;r<o.sel.ranges.length;r++){if(!e&&r==o.sel.primIndex)continue;let s=o.sel.ranges[r];if(s.from().line>=t.display.viewTo||s.to().line<t.display.viewFrom)continue;let p=s.empty();if(n){let e=n(t,s);e&&drawSelectionCursor(t,e,i)}else(p||t.options.showCursorWhenSelecting)&&drawSelectionCursor(t,s.head,i);p||drawSelectionRange(t,s,l)}return r}export function drawSelectionCursor(t,e,o){let r=cursorCoords(t,e,"div",null,null,!t.options.singleCursorHeightPerLine),i=o.appendChild(elt("div"," ","CodeMirror-cursor"));if(i.style.left=r.left+"px",i.style.top=r.top+"px",i.style.height=Math.max(0,r.bottom-r.top)*t.options.cursorHeight+"px",/\bcm-fat-cursor\b/.test(t.getWrapperElement().className)){let o=charCoords(t,e,"div",null,null),r=o.right-o.left;i.style.width=(r>0?r:t.defaultCharWidth())+"px"}if(r.other){let t=o.appendChild(elt("div"," ","CodeMirror-cursor CodeMirror-secondarycursor"));t.style.display="",t.style.left=r.other.left+"px",t.style.top=r.other.top+"px",t.style.height=.85*(r.other.bottom-r.other.top)+"px"}}function cmpCoords(t,e){return t.top-e.top||t.left-e.left}function drawSelectionRange(t,e,o){let r=t.display,i=t.doc,l=document.createDocumentFragment(),n=paddingH(t.display),s=n.left,p=Math.max(r.sizerWidth,displayWidth(t)-r.sizer.offsetLeft)-n.right,d="ltr"==i.direction;function a(t,e,o,r){e<0&&(e=0),e=Math.round(e),r=Math.round(r),l.appendChild(elt("div",null,"CodeMirror-selected",`position: absolute; left: ${t}px;\n                             top: ${e}px; width: ${null==o?p-t:o}px;\n                             height: ${r-e}px`))}function u(e,o,r){let l,n,u=getLine(i,e),c=u.text.length;function h(o,r){return charCoords(t,Pos(e,o),"div",u,r)}function f(e,o,r){let i=wrappedLineExtentChar(t,u,null,e),l="ltr"==o==("after"==r)?"left":"right";return h("after"==r?i.begin:i.end-(/\s/.test(u.text.charAt(i.end-1))?2:1),l)[l]}let m=getOrder(u,i.direction);return iterateBidiSections(m,o||0,null==r?c:r,((t,e,i,u)=>{let g="ltr"==i,C=h(t,g?"left":"right"),y=h(e-1,g?"right":"left"),b=null==o&&0==t,x=null==r&&e==c,v=0==u,w=!m||u==m.length-1;if(y.top-C.top<=3){let t=(d?x:b)&&w,e=(d?b:x)&&v?s:(g?C:y).left,o=t?p:(g?y:C).right;a(e,C.top,o-e,C.bottom)}else{let o,r,l,n;g?(o=d&&b&&v?s:C.left,r=d?p:f(t,i,"before"),l=d?s:f(e,i,"after"),n=d&&x&&w?p:y.right):(o=d?f(t,i,"before"):s,r=!d&&b&&v?p:C.right,l=!d&&x&&w?s:y.left,n=d?f(e,i,"after"):p),a(o,C.top,r-o,C.bottom),C.bottom<y.top&&a(s,C.bottom,null,y.top),a(l,y.top,n-l,y.bottom)}(!l||cmpCoords(C,l)<0)&&(l=C),cmpCoords(y,l)<0&&(l=y),(!n||cmpCoords(C,n)<0)&&(n=C),cmpCoords(y,n)<0&&(n=y)})),{start:l,end:n}}let c=e.from(),h=e.to();if(c.line==h.line)u(c.line,c.ch,h.ch);else{let t=getLine(i,c.line),e=getLine(i,h.line),o=visualLine(t)==visualLine(e),r=u(c.line,c.ch,o?t.text.length+1:null).end,l=u(h.line,o?0:null,h.ch).start;o&&(r.top<l.top-2?(a(r.right,r.top,null,r.bottom),a(s,l.top,l.left,l.bottom)):a(r.right,r.top,l.left-r.right,r.bottom)),r.bottom<l.top&&a(s,r.bottom,null,l.top)}o.appendChild(l)}export function restartBlink(t){if(!t.state.focused)return;let e=t.display;clearInterval(e.blinker);let o=!0;e.cursorDiv.style.visibility="",t.options.cursorBlinkRate>0?e.blinker=setInterval((()=>{t.hasFocus()||onBlur(t),e.cursorDiv.style.visibility=(o=!o)?"":"hidden"}),t.options.cursorBlinkRate):t.options.cursorBlinkRate<0&&(e.cursorDiv.style.visibility="hidden")}