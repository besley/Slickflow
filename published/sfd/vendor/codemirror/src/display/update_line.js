import{buildLineContent}from"../line/line_data.js";import{lineNumberFor}from"../line/utils_line.js";import{ie,ie_version}from"../util/browser.js";import{elt,classTest}from"../util/dom.js";import{signalLater}from"../util/operation_group.js";export function updateLineForChanges(e,t,n,i){for(let r=0;r<t.changes.length;r++){let l=t.changes[r];"text"==l?updateLineText(e,t):"gutter"==l?updateLineGutter(e,t,n,i):"class"==l?updateLineClasses(e,t):"widget"==l&&updateLineWidgets(e,t,i)}t.changes=null}function ensureLineWrapped(e){return e.node==e.text&&(e.node=elt("div",null,null,"position: relative"),e.text.parentNode&&e.text.parentNode.replaceChild(e.node,e.text),e.node.appendChild(e.text),ie&&ie_version<8&&(e.node.style.zIndex=2)),e.node}function updateLineBackground(e,t){let n=t.bgClass?t.bgClass+" "+(t.line.bgClass||""):t.line.bgClass;if(n&&(n+=" CodeMirror-linebackground"),t.background)n?t.background.className=n:(t.background.parentNode.removeChild(t.background),t.background=null);else if(n){let i=ensureLineWrapped(t);t.background=i.insertBefore(elt("div",null,n),i.firstChild),e.display.input.setUneditable(t.background)}}function getLineContent(e,t){let n=e.display.externalMeasured;return n&&n.line==t.line?(e.display.externalMeasured=null,t.measure=n.measure,n.built):buildLineContent(e,t)}function updateLineText(e,t){let n=t.text.className,i=getLineContent(e,t);t.text==t.node&&(t.node=i.pre),t.text.parentNode.replaceChild(i.pre,t.text),t.text=i.pre,i.bgClass!=t.bgClass||i.textClass!=t.textClass?(t.bgClass=i.bgClass,t.textClass=i.textClass,updateLineClasses(e,t)):n&&(t.text.className=n)}function updateLineClasses(e,t){updateLineBackground(e,t),t.line.wrapClass?ensureLineWrapped(t).className=t.line.wrapClass:t.node!=t.text&&(t.node.className="");let n=t.textClass?t.textClass+" "+(t.line.textClass||""):t.line.textClass;t.text.className=n||""}function updateLineGutter(e,t,n,i){if(t.gutter&&(t.node.removeChild(t.gutter),t.gutter=null),t.gutterBackground&&(t.node.removeChild(t.gutterBackground),t.gutterBackground=null),t.line.gutterClass){let n=ensureLineWrapped(t);t.gutterBackground=elt("div",null,"CodeMirror-gutter-background "+t.line.gutterClass,`left: ${e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth}px; width: ${i.gutterTotalWidth}px`),e.display.input.setUneditable(t.gutterBackground),n.insertBefore(t.gutterBackground,t.text)}let r=t.line.gutterMarkers;if(e.options.lineNumbers||r){let l=ensureLineWrapped(t),s=t.gutter=elt("div",null,"CodeMirror-gutter-wrapper",`left: ${e.options.fixedGutter?i.fixedPos:-i.gutterTotalWidth}px`);if(s.setAttribute("aria-hidden","true"),e.display.input.setUneditable(s),l.insertBefore(s,t.text),t.line.gutterClass&&(s.className+=" "+t.line.gutterClass),!e.options.lineNumbers||r&&r["CodeMirror-linenumbers"]||(t.lineNumber=s.appendChild(elt("div",lineNumberFor(e.options,n),"CodeMirror-linenumber CodeMirror-gutter-elt",`left: ${i.gutterLeft["CodeMirror-linenumbers"]}px; width: ${e.display.lineNumInnerWidth}px`))),r)for(let t=0;t<e.display.gutterSpecs.length;++t){let n=e.display.gutterSpecs[t].className,l=r.hasOwnProperty(n)&&r[n];l&&s.appendChild(elt("div",[l],"CodeMirror-gutter-elt",`left: ${i.gutterLeft[n]}px; width: ${i.gutterWidth[n]}px`))}}}function updateLineWidgets(e,t,n){t.alignable&&(t.alignable=null);let i=classTest("CodeMirror-linewidget");for(let e,n=t.node.firstChild;n;n=e)e=n.nextSibling,i.test(n.className)&&t.node.removeChild(n);insertLineWidgets(e,t,n)}export function buildLineElement(e,t,n,i){let r=getLineContent(e,t);return t.text=t.node=r.pre,r.bgClass&&(t.bgClass=r.bgClass),r.textClass&&(t.textClass=r.textClass),updateLineClasses(e,t),updateLineGutter(e,t,n,i),insertLineWidgets(e,t,i),t.node}function insertLineWidgets(e,t,n){if(insertLineWidgetsFor(e,t.line,t,n,!0),t.rest)for(let i=0;i<t.rest.length;i++)insertLineWidgetsFor(e,t.rest[i],t,n,!1)}function insertLineWidgetsFor(e,t,n,i,r){if(!t.widgets)return;let l=ensureLineWrapped(n);for(let s=0,a=t.widgets;s<a.length;++s){let t=a[s],d=elt("div",[t.node],"CodeMirror-linewidget"+(t.className?" "+t.className:""));t.handleMouseEvents||d.setAttribute("cm-ignore-events","true"),positionLineWidget(t,d,n,i),e.display.input.setUneditable(d),r&&t.above?l.insertBefore(d,n.gutter||n.text):l.appendChild(d),signalLater(t,"redraw")}}function positionLineWidget(e,t,n,i){if(e.noHScroll){(n.alignable||(n.alignable=[])).push(t);let r=i.wrapperWidth;t.style.left=i.fixedPos+"px",e.coverGutter||(r-=i.gutterTotalWidth,t.style.paddingLeft=i.gutterTotalWidth+"px"),t.style.width=r+"px"}e.coverGutter&&(t.style.zIndex=5,t.style.position="relative",e.noHScroll||(t.style.marginLeft=-i.gutterTotalWidth+"px"))}