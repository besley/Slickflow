import{chrome,gecko,ie,mac,presto,safari,webkit}from"../util/browser.js";import{e_preventDefault}from"../util/event.js";import{updateDisplaySimple}from"./update_display.js";import{setScrollLeft,updateScrollTop}from"./scrolling.js";let wheelSamples=0,wheelPixelsPerUnit=null;function wheelEventDelta(e){let l=e.wheelDeltaX,t=e.wheelDeltaY;return null==l&&e.detail&&e.axis==e.HORIZONTAL_AXIS&&(l=e.detail),null==t&&e.detail&&e.axis==e.VERTICAL_AXIS?t=e.detail:null==t&&(t=e.wheelDelta),{x:l,y:t}}ie?wheelPixelsPerUnit=-.53:gecko?wheelPixelsPerUnit=15:chrome?wheelPixelsPerUnit=-.7:safari&&(wheelPixelsPerUnit=-1/3);export function wheelEventPixels(e){let l=wheelEventDelta(e);return l.x*=wheelPixelsPerUnit,l.y*=wheelPixelsPerUnit,l}export function onScrollWheel(e,l){let t=wheelEventDelta(l),r=t.x,i=t.y,a=wheelPixelsPerUnit;0===l.deltaMode&&(r=l.deltaX,i=l.deltaY,a=1);let o=e.display,h=o.scroller,n=h.scrollWidth>h.clientWidth,s=h.scrollHeight>h.clientHeight;if(r&&n||i&&s){if(i&&mac&&webkit)e:for(let t=l.target,r=o.view;t!=h;t=t.parentNode)for(let l=0;l<r.length;l++)if(r[l].node==t){e.display.currentWheelTarget=t;break e}if(r&&!gecko&&!presto&&null!=a)return i&&s&&updateScrollTop(e,Math.max(0,h.scrollTop+i*a)),setScrollLeft(e,Math.max(0,h.scrollLeft+r*a)),(!i||i&&s)&&e_preventDefault(l),void(o.wheelStartX=null);if(i&&null!=a){let l=i*a,t=e.doc.scrollTop,r=t+o.wrapper.clientHeight;l<0?t=Math.max(0,t+l-50):r=Math.min(e.doc.height,r+l+50),updateDisplaySimple(e,{top:t,bottom:r})}wheelSamples<20&&0!==l.deltaMode&&(null==o.wheelStartX?(o.wheelStartX=h.scrollLeft,o.wheelStartY=h.scrollTop,o.wheelDX=r,o.wheelDY=i,setTimeout((()=>{if(null==o.wheelStartX)return;let e=h.scrollLeft-o.wheelStartX,l=h.scrollTop-o.wheelStartY,t=l&&o.wheelDY&&l/o.wheelDY||e&&o.wheelDX&&e/o.wheelDX;o.wheelStartX=o.wheelStartY=null,t&&(wheelPixelsPerUnit=(wheelPixelsPerUnit*wheelSamples+t)/(wheelSamples+1),++wheelSamples)}),200)):(o.wheelDX+=r,o.wheelDY+=i))}}