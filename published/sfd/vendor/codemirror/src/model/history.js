import{cmp,copyPos}from"../line/pos.js";import{stretchSpansOverChange}from"../line/spans.js";import{getBetween}from"../line/utils_line.js";import{signal}from"../util/event.js";import{indexOf,lst}from"../util/misc.js";import{changeEnd}from"./change_measurement.js";import{linkedDocs}from"./document_data.js";import{Selection}from"./selection.js";export function History(e){this.done=[],this.undone=[],this.undoDepth=e?e.undoDepth:1/0,this.lastModTime=this.lastSelTime=0,this.lastOp=this.lastSelOp=null,this.lastOrigin=this.lastSelOrigin=null,this.generation=this.maxGeneration=e?e.maxGeneration:1}export function historyChangeFromChange(e,t){let n={from:copyPos(t.from),to:changeEnd(t),text:getBetween(e,t.from,t.to)};return attachLocalSpans(e,n,t.from.line,t.to.line+1),linkedDocs(e,(e=>attachLocalSpans(e,n,t.from.line,t.to.line+1)),!0),n}function clearSelectionEvents(e){for(;e.length&&lst(e).ranges;)e.pop()}function lastChangeEvent(e,t){return t?(clearSelectionEvents(e.done),lst(e.done)):e.done.length&&!lst(e.done).ranges?lst(e.done):e.done.length>1&&!e.done[e.done.length-2].ranges?(e.done.pop(),lst(e.done)):void 0}export function addChangeToHistory(e,t,n,o){let l=e.history;l.undone.length=0;let s,i,r=+new Date;if((l.lastOp==o||l.lastOrigin==t.origin&&t.origin&&("+"==t.origin.charAt(0)&&l.lastModTime>r-(e.cm?e.cm.options.historyEventDelay:500)||"*"==t.origin.charAt(0)))&&(s=lastChangeEvent(l,l.lastOp==o)))i=lst(s.changes),0==cmp(t.from,t.to)&&0==cmp(t.from,i.to)?i.to=changeEnd(t):s.changes.push(historyChangeFromChange(e,t));else{let n=lst(l.done);for(n&&n.ranges||pushSelectionToHistory(e.sel,l.done),s={changes:[historyChangeFromChange(e,t)],generation:l.generation},l.done.push(s);l.done.length>l.undoDepth;)l.done.shift(),l.done[0].ranges||l.done.shift()}l.done.push(n),l.generation=++l.maxGeneration,l.lastModTime=l.lastSelTime=r,l.lastOp=l.lastSelOp=o,l.lastOrigin=l.lastSelOrigin=t.origin,i||signal(e,"historyAdded")}function selectionEventCanBeMerged(e,t,n,o){let l=t.charAt(0);return"*"==l||"+"==l&&n.ranges.length==o.ranges.length&&n.somethingSelected()==o.somethingSelected()&&new Date-e.history.lastSelTime<=(e.cm?e.cm.options.historyEventDelay:500)}export function addSelectionToHistory(e,t,n,o){let l=e.history,s=o&&o.origin;n==l.lastSelOp||s&&l.lastSelOrigin==s&&(l.lastModTime==l.lastSelTime&&l.lastOrigin==s||selectionEventCanBeMerged(e,s,lst(l.done),t))?l.done[l.done.length-1]=t:pushSelectionToHistory(t,l.done),l.lastSelTime=+new Date,l.lastSelOrigin=s,l.lastSelOp=n,o&&!1!==o.clearRedo&&clearSelectionEvents(l.undone)}export function pushSelectionToHistory(e,t){let n=lst(t);n&&n.ranges&&n.equals(e)||t.push(e)}function attachLocalSpans(e,t,n,o){let l=t["spans_"+e.id],s=0;e.iter(Math.max(e.first,n),Math.min(e.first+e.size,o),(n=>{n.markedSpans&&((l||(l=t["spans_"+e.id]={}))[s]=n.markedSpans),++s}))}function removeClearedSpans(e){if(!e)return null;let t;for(let n=0;n<e.length;++n)e[n].marker.explicitlyCleared?t||(t=e.slice(0,n)):t&&t.push(e[n]);return t?t.length?t:null:e}function getOldSpans(e,t){let n=t["spans_"+e.id];if(!n)return null;let o=[];for(let e=0;e<t.text.length;++e)o.push(removeClearedSpans(n[e]));return o}export function mergeOldSpans(e,t){let n=getOldSpans(e,t),o=stretchSpansOverChange(e,t);if(!n)return o;if(!o)return n;for(let e=0;e<n.length;++e){let t=n[e],l=o[e];if(t&&l)e:for(let e=0;e<l.length;++e){let n=l[e];for(let e=0;e<t.length;++e)if(t[e].marker==n.marker)continue e;t.push(n)}else l&&(n[e]=l)}return n}export function copyHistoryArray(e,t,n){let o=[];for(let s=0;s<e.length;++s){let i=e[s];if(i.ranges){o.push(n?Selection.prototype.deepCopy.call(i):i);continue}let r=i.changes,a=[];o.push({changes:a});for(let e=0;e<r.length;++e){let n,o=r[e];if(a.push({from:o.from,to:o.to,text:o.text}),t)for(var l in o)(n=l.match(/^spans_(\d+)$/))&&indexOf(t,Number(n[1]))>-1&&(lst(a)[l]=o[l],delete o[l])}}return o}