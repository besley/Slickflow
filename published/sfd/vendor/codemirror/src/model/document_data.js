import{loadMode}from"../display/mode_state.js";import{runInOp}from"../display/operations.js";import{regChange}from"../display/view_tracking.js";import{Line,updateLine}from"../line/line_data.js";import{findMaxLine}from"../line/spans.js";import{getLine}from"../line/utils_line.js";import{estimateLineHeights}from"../measurement/position_measurement.js";import{addClass,rmClass}from"../util/dom.js";import{lst}from"../util/misc.js";import{signalLater}from"../util/operation_group.js";export function isWholeLineUpdate(e,t){return 0==t.from.ch&&0==t.to.ch&&""==lst(t.text)&&(!e.cm||e.cm.options.wholeLineUpdateBefore)}export function updateDoc(e,t,i,n){function o(e){return i?i[e]:null}function l(e,i,o){updateLine(e,i,o,n),signalLater(e,"change",e,t)}function s(e,t){let i=[];for(let l=e;l<t;++l)i.push(new Line(a[l],o(l),n));return i}let r=t.from,c=t.to,a=t.text,m=getLine(e,r.line),d=getLine(e,c.line),p=lst(a),h=o(a.length-1),f=c.line-r.line;if(t.full)e.insert(0,s(0,a.length)),e.remove(a.length,e.size-a.length);else if(isWholeLineUpdate(e,t)){let t=s(0,a.length-1);l(d,d.text,h),f&&e.remove(r.line,f),t.length&&e.insert(r.line,t)}else if(m==d)if(1==a.length)l(m,m.text.slice(0,r.ch)+p+m.text.slice(c.ch),h);else{let t=s(1,a.length-1);t.push(new Line(p+m.text.slice(c.ch),h,n)),l(m,m.text.slice(0,r.ch)+a[0],o(0)),e.insert(r.line+1,t)}else if(1==a.length)l(m,m.text.slice(0,r.ch)+a[0]+d.text.slice(c.ch),o(0)),e.remove(r.line+1,f);else{l(m,m.text.slice(0,r.ch)+a[0],o(0)),l(d,p+d.text.slice(c.ch),h);let t=s(1,a.length-1);f>1&&e.remove(r.line+1,f-1),e.insert(r.line+1,t)}signalLater(e,"change",e,t)}export function linkedDocs(e,t,i){!function e(n,o,l){if(n.linked)for(let s=0;s<n.linked.length;++s){let r=n.linked[s];if(r.doc==o)continue;let c=l&&r.sharedHist;i&&!c||(t(r.doc,c),e(r.doc,n,c))}}(e,null,!0)}export function attachDoc(e,t){if(t.cm)throw new Error("This document is already in use.");e.doc=t,t.cm=e,estimateLineHeights(e),loadMode(e),setDirectionClass(e),e.options.direction=t.direction,e.options.lineWrapping||findMaxLine(e),e.options.mode=t.modeOption,regChange(e)}function setDirectionClass(e){("rtl"==e.doc.direction?addClass:rmClass)(e.display.lineDiv,"CodeMirror-rtl")}export function directionChanged(e){runInOp(e,(()=>{setDirectionClass(e),regChange(e)}))}