import CodeMirror from"../edit/CodeMirror.js";import{docMethodOp}from"../display/operations.js";import{Line}from"../line/line_data.js";import{clipPos,clipPosArray,Pos}from"../line/pos.js";import{visualLine}from"../line/spans.js";import{getBetween,getLine,getLines,isLine,lineNo}from"../line/utils_line.js";import{classTest}from"../util/dom.js";import{splitLinesAuto}from"../util/feature_detection.js";import{createObj,map,isEmpty,sel_dontScroll}from"../util/misc.js";import{ensureCursorVisible,scrollToCoords}from"../display/scrolling.js";import{changeLine,makeChange,makeChangeFromHistory,replaceRange}from"./changes.js";import{computeReplacedSel}from"./change_measurement.js";import{BranchChunk,LeafChunk}from"./chunk.js";import{directionChanged,linkedDocs,updateDoc}from"./document_data.js";import{copyHistoryArray,History}from"./history.js";import{addLineWidget}from"./line_widget.js";import{copySharedMarkers,detachSharedMarkers,findSharedMarkers,markText}from"./mark_text.js";import{normalizeSelection,Range,simpleSelection}from"./selection.js";import{extendSelection,extendSelections,setSelection,setSelectionReplaceHistory,setSimpleSelection}from"./selection_updates.js";let nextDocId=0,Doc=function(t,e,i,n,s){if(!(this instanceof Doc))return new Doc(t,e,i,n,s);null==i&&(i=0),BranchChunk.call(this,[new LeafChunk([new Line("",null)])]),this.first=i,this.scrollTop=this.scrollLeft=0,this.cantEdit=!1,this.cleanGeneration=1,this.modeFrontier=this.highlightFrontier=i;let r=Pos(i,0);this.sel=simpleSelection(r),this.history=new History(null),this.id=++nextDocId,this.modeOption=e,this.lineSep=n,this.direction="rtl"==s?"rtl":"ltr",this.extend=!1,"string"==typeof t&&(t=this.splitLines(t)),updateDoc(this,{from:r,to:r,text:t}),setSelection(this,simpleSelection(r),sel_dontScroll)};Doc.prototype=createObj(BranchChunk.prototype,{constructor:Doc,iter:function(t,e,i){i?this.iterN(t-this.first,e-t,i):this.iterN(this.first,this.first+this.size,t)},insert:function(t,e){let i=0;for(let t=0;t<e.length;++t)i+=e[t].height;this.insertInner(t-this.first,e,i)},remove:function(t,e){this.removeInner(t-this.first,e)},getValue:function(t){let e=getLines(this,this.first,this.first+this.size);return!1===t?e:e.join(t||this.lineSeparator())},setValue:docMethodOp((function(t){let e=Pos(this.first,0),i=this.first+this.size-1;makeChange(this,{from:e,to:Pos(i,getLine(this,i).text.length),text:this.splitLines(t),origin:"setValue",full:!0},!0),this.cm&&scrollToCoords(this.cm,0,0),setSelection(this,simpleSelection(e),sel_dontScroll)})),replaceRange:function(t,e,i,n){e=clipPos(this,e),i=i?clipPos(this,i):e,replaceRange(this,t,e,i,n)},getRange:function(t,e,i){let n=getBetween(this,clipPos(this,t),clipPos(this,e));return!1===i?n:""===i?n.join(""):n.join(i||this.lineSeparator())},getLine:function(t){let e=this.getLineHandle(t);return e&&e.text},getLineHandle:function(t){if(isLine(this,t))return getLine(this,t)},getLineNumber:function(t){return lineNo(t)},getLineHandleVisualStart:function(t){return"number"==typeof t&&(t=getLine(this,t)),visualLine(t)},lineCount:function(){return this.size},firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(t){return clipPos(this,t)},getCursor:function(t){let e,i=this.sel.primary();return e=null==t||"head"==t?i.head:"anchor"==t?i.anchor:"end"==t||"to"==t||!1===t?i.to():i.from(),e},listSelections:function(){return this.sel.ranges},somethingSelected:function(){return this.sel.somethingSelected()},setCursor:docMethodOp((function(t,e,i){setSimpleSelection(this,clipPos(this,"number"==typeof t?Pos(t,e||0):t),null,i)})),setSelection:docMethodOp((function(t,e,i){setSimpleSelection(this,clipPos(this,t),clipPos(this,e||t),i)})),extendSelection:docMethodOp((function(t,e,i){extendSelection(this,clipPos(this,t),e&&clipPos(this,e),i)})),extendSelections:docMethodOp((function(t,e){extendSelections(this,clipPosArray(this,t),e)})),extendSelectionsBy:docMethodOp((function(t,e){let i=map(this.sel.ranges,t);extendSelections(this,clipPosArray(this,i),e)})),setSelections:docMethodOp((function(t,e,i){if(!t.length)return;let n=[];for(let e=0;e<t.length;e++)n[e]=new Range(clipPos(this,t[e].anchor),clipPos(this,t[e].head||t[e].anchor));null==e&&(e=Math.min(t.length-1,this.sel.primIndex)),setSelection(this,normalizeSelection(this.cm,n,e),i)})),addSelection:docMethodOp((function(t,e,i){let n=this.sel.ranges.slice(0);n.push(new Range(clipPos(this,t),clipPos(this,e||t))),setSelection(this,normalizeSelection(this.cm,n,n.length-1),i)})),getSelection:function(t){let e,i=this.sel.ranges;for(let t=0;t<i.length;t++){let n=getBetween(this,i[t].from(),i[t].to());e=e?e.concat(n):n}return!1===t?e:e.join(t||this.lineSeparator())},getSelections:function(t){let e=[],i=this.sel.ranges;for(let n=0;n<i.length;n++){let s=getBetween(this,i[n].from(),i[n].to());!1!==t&&(s=s.join(t||this.lineSeparator())),e[n]=s}return e},replaceSelection:function(t,e,i){let n=[];for(let e=0;e<this.sel.ranges.length;e++)n[e]=t;this.replaceSelections(n,e,i||"+input")},replaceSelections:docMethodOp((function(t,e,i){let n=[],s=this.sel;for(let e=0;e<s.ranges.length;e++){let r=s.ranges[e];n[e]={from:r.from(),to:r.to(),text:this.splitLines(t[e]),origin:i}}let r=e&&"end"!=e&&computeReplacedSel(this,n,e);for(let t=n.length-1;t>=0;t--)makeChange(this,n[t]);r?setSelectionReplaceHistory(this,r):this.cm&&ensureCursorVisible(this.cm)})),undo:docMethodOp((function(){makeChangeFromHistory(this,"undo")})),redo:docMethodOp((function(){makeChangeFromHistory(this,"redo")})),undoSelection:docMethodOp((function(){makeChangeFromHistory(this,"undo",!0)})),redoSelection:docMethodOp((function(){makeChangeFromHistory(this,"redo",!0)})),setExtending:function(t){this.extend=t},getExtending:function(){return this.extend},historySize:function(){let t=this.history,e=0,i=0;for(let i=0;i<t.done.length;i++)t.done[i].ranges||++e;for(let e=0;e<t.undone.length;e++)t.undone[e].ranges||++i;return{undo:e,redo:i}},clearHistory:function(){this.history=new History(this.history),linkedDocs(this,(t=>t.history=this.history),!0)},markClean:function(){this.cleanGeneration=this.changeGeneration(!0)},changeGeneration:function(t){return t&&(this.history.lastOp=this.history.lastSelOp=this.history.lastOrigin=null),this.history.generation},isClean:function(t){return this.history.generation==(t||this.cleanGeneration)},getHistory:function(){return{done:copyHistoryArray(this.history.done),undone:copyHistoryArray(this.history.undone)}},setHistory:function(t){let e=this.history=new History(this.history);e.done=copyHistoryArray(t.done.slice(0),null,!0),e.undone=copyHistoryArray(t.undone.slice(0),null,!0)},setGutterMarker:docMethodOp((function(t,e,i){return changeLine(this,t,"gutter",(t=>{let n=t.gutterMarkers||(t.gutterMarkers={});return n[e]=i,!i&&isEmpty(n)&&(t.gutterMarkers=null),!0}))})),clearGutter:docMethodOp((function(t){this.iter((e=>{e.gutterMarkers&&e.gutterMarkers[t]&&changeLine(this,e,"gutter",(()=>(e.gutterMarkers[t]=null,isEmpty(e.gutterMarkers)&&(e.gutterMarkers=null),!0)))}))})),lineInfo:function(t){let e;if("number"==typeof t){if(!isLine(this,t))return null;if(e=t,!(t=getLine(this,t)))return null}else if(e=lineNo(t),null==e)return null;return{line:e,handle:t,text:t.text,gutterMarkers:t.gutterMarkers,textClass:t.textClass,bgClass:t.bgClass,wrapClass:t.wrapClass,widgets:t.widgets}},addLineClass:docMethodOp((function(t,e,i){return changeLine(this,t,"gutter"==e?"gutter":"class",(t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass";if(t[n]){if(classTest(i).test(t[n]))return!1;t[n]+=" "+i}else t[n]=i;return!0}))})),removeLineClass:docMethodOp((function(t,e,i){return changeLine(this,t,"gutter"==e?"gutter":"class",(t=>{let n="text"==e?"textClass":"background"==e?"bgClass":"gutter"==e?"gutterClass":"wrapClass",s=t[n];if(!s)return!1;if(null==i)t[n]=null;else{let e=s.match(classTest(i));if(!e)return!1;let r=e.index+e[0].length;t[n]=s.slice(0,e.index)+(e.index&&r!=s.length?" ":"")+s.slice(r)||null}return!0}))})),addLineWidget:docMethodOp((function(t,e,i){return addLineWidget(this,t,e,i)})),removeLineWidget:function(t){t.clear()},markText:function(t,e,i){return markText(this,clipPos(this,t),clipPos(this,e),i,i&&i.type||"range")},setBookmark:function(t,e){let i={replacedWith:e&&(null==e.nodeType?e.widget:e),insertLeft:e&&e.insertLeft,clearWhenEmpty:!1,shared:e&&e.shared,handleMouseEvents:e&&e.handleMouseEvents};return t=clipPos(this,t),markText(this,t,t,i,"bookmark")},findMarksAt:function(t){t=clipPos(this,t);let e=[],i=getLine(this,t.line).markedSpans;if(i)for(let n=0;n<i.length;++n){let s=i[n];(null==s.from||s.from<=t.ch)&&(null==s.to||s.to>=t.ch)&&e.push(s.marker.parent||s.marker)}return e},findMarks:function(t,e,i){t=clipPos(this,t),e=clipPos(this,e);let n=[],s=t.line;return this.iter(t.line,e.line+1,(r=>{let o=r.markedSpans;if(o)for(let r=0;r<o.length;r++){let l=o[r];null!=l.to&&s==t.line&&t.ch>=l.to||null==l.from&&s!=t.line||null!=l.from&&s==e.line&&l.from>=e.ch||i&&!i(l.marker)||n.push(l.marker.parent||l.marker)}++s})),n},getAllMarks:function(){let t=[];return this.iter((e=>{let i=e.markedSpans;if(i)for(let e=0;e<i.length;++e)null!=i[e].from&&t.push(i[e].marker)})),t},posFromIndex:function(t){let e,i=this.first,n=this.lineSeparator().length;return this.iter((s=>{let r=s.text.length+n;if(r>t)return e=t,!0;t-=r,++i})),clipPos(this,Pos(i,e))},indexFromPos:function(t){let e=(t=clipPos(this,t)).ch;if(t.line<this.first||t.ch<0)return 0;let i=this.lineSeparator().length;return this.iter(this.first,t.line,(t=>{e+=t.text.length+i})),e},copy:function(t){let e=new Doc(getLines(this,this.first,this.first+this.size),this.modeOption,this.first,this.lineSep,this.direction);return e.scrollTop=this.scrollTop,e.scrollLeft=this.scrollLeft,e.sel=this.sel,e.extend=!1,t&&(e.history.undoDepth=this.history.undoDepth,e.setHistory(this.getHistory())),e},linkedDoc:function(t){t||(t={});let e=this.first,i=this.first+this.size;null!=t.from&&t.from>e&&(e=t.from),null!=t.to&&t.to<i&&(i=t.to);let n=new Doc(getLines(this,e,i),t.mode||this.modeOption,e,this.lineSep,this.direction);return t.sharedHist&&(n.history=this.history),(this.linked||(this.linked=[])).push({doc:n,sharedHist:t.sharedHist}),n.linked=[{doc:this,isParent:!0,sharedHist:t.sharedHist}],copySharedMarkers(n,findSharedMarkers(this)),n},unlinkDoc:function(t){if(t instanceof CodeMirror&&(t=t.doc),this.linked)for(let e=0;e<this.linked.length;++e)if(this.linked[e].doc==t){this.linked.splice(e,1),t.unlinkDoc(this),detachSharedMarkers(findSharedMarkers(this));break}if(t.history==this.history){let e=[t.id];linkedDocs(t,(t=>e.push(t.id)),!0),t.history=new History(null),t.history.done=copyHistoryArray(this.history.done,e),t.history.undone=copyHistoryArray(this.history.undone,e)}},iterLinkedDocs:function(t){linkedDocs(this,t)},getMode:function(){return this.mode},getEditor:function(){return this.cm},splitLines:function(t){return this.lineSep?t.split(this.lineSep):splitLinesAuto(t)},lineSeparator:function(){return this.lineSep||"\n"},setDirection:docMethodOp((function(t){"rtl"!=t&&(t="ltr"),t!=this.direction&&(this.direction=t,this.iter((t=>t.order=null)),this.cm&&directionChanged(this.cm))}))}),Doc.prototype.eachLine=Doc.prototype.iter;export default Doc;