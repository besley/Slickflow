import{cleanUpLine}from"../line/line_data.js";import{indexOf}from"../util/misc.js";import{signalLater}from"../util/operation_group.js";export function LeafChunk(e){this.lines=e,this.parent=null;let i=0;for(let t=0;t<e.length;++t)e[t].parent=this,i+=e[t].height;this.height=i}LeafChunk.prototype={chunkSize(){return this.lines.length},removeInner(e,i){for(let t=e,h=e+i;t<h;++t){let e=this.lines[t];this.height-=e.height,cleanUpLine(e),signalLater(e,"delete")}this.lines.splice(e,i)},collapse(e){e.push.apply(e,this.lines)},insertInner(e,i,t){this.height+=t,this.lines=this.lines.slice(0,e).concat(i).concat(this.lines.slice(e));for(let e=0;e<i.length;++e)i[e].parent=this},iterN(e,i,t){for(let h=e+i;e<h;++e)if(t(this.lines[e]))return!0}};export function BranchChunk(e){this.children=e;let i=0,t=0;for(let h=0;h<e.length;++h){let n=e[h];i+=n.chunkSize(),t+=n.height,n.parent=this}this.size=i,this.height=t,this.parent=null}BranchChunk.prototype={chunkSize(){return this.size},removeInner(e,i){this.size-=i;for(let t=0;t<this.children.length;++t){let h=this.children[t],n=h.chunkSize();if(e<n){let l=Math.min(i,n-e),s=h.height;if(h.removeInner(e,l),this.height-=s-h.height,n==l&&(this.children.splice(t--,1),h.parent=null),0==(i-=l))break;e=0}else e-=n}if(this.size-i<25&&(this.children.length>1||!(this.children[0]instanceof LeafChunk))){let e=[];this.collapse(e),this.children=[new LeafChunk(e)],this.children[0].parent=this}},collapse(e){for(let i=0;i<this.children.length;++i)this.children[i].collapse(e)},insertInner(e,i,t){this.size+=i.length,this.height+=t;for(let h=0;h<this.children.length;++h){let n=this.children[h],l=n.chunkSize();if(e<=l){if(n.insertInner(e,i,t),n.lines&&n.lines.length>50){let e=n.lines.length%25+25;for(let i=e;i<n.lines.length;){let e=new LeafChunk(n.lines.slice(i,i+=25));n.height-=e.height,this.children.splice(++h,0,e),e.parent=this}n.lines=n.lines.slice(0,e),this.maybeSpill()}break}e-=l}},maybeSpill(){if(this.children.length<=10)return;let e=this;do{let i=new BranchChunk(e.children.splice(e.children.length-5,5));if(e.parent){e.size-=i.size,e.height-=i.height;let t=indexOf(e.parent.children,e);e.parent.children.splice(t+1,0,i)}else{let t=new BranchChunk(e.children);t.parent=e,e.children=[t,i],e=t}i.parent=e.parent}while(e.children.length>10);e.parent.maybeSpill()},iterN(e,i,t){for(let h=0;h<this.children.length;++h){let n=this.children[h],l=n.chunkSize();if(e<l){let h=Math.min(i,l-e);if(n.iterN(e,h,t))return!0;if(0==(i-=h))break;e=0}else e-=l}}};