import{runInOp}from"../display/operations.js";import{addToScrollTop}from"../display/scrolling.js";import{regLineChange}from"../display/view_tracking.js";import{heightAtLine,lineIsHidden}from"../line/spans.js";import{lineNo,updateLineHeight}from"../line/utils_line.js";import{widgetHeight}from"../measurement/widgets.js";import{changeLine}from"./changes.js";import{eventMixin}from"../util/event.js";import{signalLater}from"../util/operation_group.js";export class LineWidget{constructor(e,i,t){if(t)for(let e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);this.doc=e,this.node=i}clear(){let e=this.doc.cm,i=this.line.widgets,t=this.line,n=lineNo(t);if(null==n||!i)return;for(let e=0;e<i.length;++e)i[e]==this&&i.splice(e--,1);i.length||(t.widgets=null);let l=widgetHeight(this);updateLineHeight(t,Math.max(0,t.height-l)),e&&(runInOp(e,(()=>{adjustScrollWhenAboveVisible(e,t,-l),regLineChange(e,n,"widget")})),signalLater(e,"lineWidgetCleared",e,this,n))}changed(){let e=this.height,i=this.doc.cm,t=this.line;this.height=null;let n=widgetHeight(this)-e;n&&(lineIsHidden(this.doc,t)||updateLineHeight(t,t.height+n),i&&runInOp(i,(()=>{i.curOp.forceUpdate=!0,adjustScrollWhenAboveVisible(i,t,n),signalLater(i,"lineWidgetChanged",i,this,lineNo(t))})))}}function adjustScrollWhenAboveVisible(e,i,t){heightAtLine(i)<(e.curOp&&e.curOp.scrollTop||e.doc.scrollTop)&&addToScrollTop(e,t)}eventMixin(LineWidget);export function addLineWidget(e,i,t,n){let l=new LineWidget(e,t,n),o=e.cm;return o&&l.noHScroll&&(o.display.alignWidgets=!0),changeLine(e,i,"widget",(i=>{let t=i.widgets||(i.widgets=[]);if(null==l.insertAt?t.push(l):t.splice(Math.min(t.length,Math.max(0,l.insertAt)),0,l),l.line=i,o&&!lineIsHidden(e,i)){let t=heightAtLine(i)<e.scrollTop;updateLineHeight(i,i.height+widgetHeight(l)),t&&addToScrollTop(o,l.height),o.curOp.forceUpdate=!0}return!0})),o&&signalLater(o,"lineWidgetAdded",o,l,"number"==typeof i?i:lineNo(i)),l}