import{deleteNearSelection}from"./deleteNearSelection.js";import{commands}from"./commands.js";import{attachDoc}from"../model/document_data.js";import{activeElt,addClass,rmClass}from"../util/dom.js";import{eventMixin,signal}from"../util/event.js";import{getLineStyles,getContextBefore,takeToken}from"../line/highlight.js";import{indentLine}from"../input/indent.js";import{triggerElectric}from"../input/input.js";import{onKeyDown,onKeyPress,onKeyUp}from"./key_events.js";import{onMouseDown}from"./mouse_events.js";import{getKeyMap}from"../input/keymap.js";import{endOfLine,moveLogically,moveVisually}from"../input/movement.js";import{endOperation,methodOp,operation,runInOp,startOperation}from"../display/operations.js";import{clipLine,clipPos,equalCursorPos,Pos}from"../line/pos.js";import{charCoords,charWidth,clearCaches,clearLineMeasurementCache,coordsChar,cursorCoords,displayHeight,displayWidth,estimateLineHeights,fromCoordSystem,intoCoordSystem,scrollGap,textHeight}from"../measurement/position_measurement.js";import{Range}from"../model/selection.js";import{replaceOneSelection,skipAtomic}from"../model/selection_updates.js";import{addToScrollTop,ensureCursorVisible,scrollIntoView,scrollToCoords,scrollToCoordsRange,scrollToRange}from"../display/scrolling.js";import{heightAtLine}from"../line/spans.js";import{updateGutterSpace}from"../display/update_display.js";import{indexOf,insertSorted,isWordChar,sel_dontScroll,sel_move}from"../util/misc.js";import{signalLater}from"../util/operation_group.js";import{getLine,isLine,lineAtHeight}from"../line/utils_line.js";import{regChange,regLineChange}from"../display/view_tracking.js";export default function(t){let e=t.optionHandlers,i=t.helpers={};t.prototype={constructor:t,focus:function(){window.focus(),this.display.input.focus()},setOption:function(t,i){let o=this.options,s=o[t];o[t]==i&&"mode"!=t||(o[t]=i,e.hasOwnProperty(t)&&operation(this,e[t])(this,i,s),signal(this,"optionChange",this,t))},getOption:function(t){return this.options[t]},getDoc:function(){return this.doc},addKeyMap:function(t,e){this.state.keyMaps[e?"push":"unshift"](getKeyMap(t))},removeKeyMap:function(t){let e=this.state.keyMaps;for(let i=0;i<e.length;++i)if(e[i]==t||e[i].name==t)return e.splice(i,1),!0},addOverlay:methodOp((function(e,i){let o=e.token?e:t.getMode(this.options,e);if(o.startState)throw new Error("Overlays may not be stateful.");insertSorted(this.state.overlays,{mode:o,modeSpec:e,opaque:i&&i.opaque,priority:i&&i.priority||0},(t=>t.priority)),this.state.modeGen++,regChange(this)})),removeOverlay:methodOp((function(t){let e=this.state.overlays;for(let i=0;i<e.length;++i){let o=e[i].modeSpec;if(o==t||"string"==typeof t&&o.name==t)return e.splice(i,1),this.state.modeGen++,void regChange(this)}})),indentLine:methodOp((function(t,e,i){"string"!=typeof e&&"number"!=typeof e&&(e=null==e?this.options.smartIndent?"smart":"prev":e?"add":"subtract"),isLine(this.doc,t)&&indentLine(this,t,e,i)})),indentSelection:methodOp((function(t){let e=this.doc.sel.ranges,i=-1;for(let o=0;o<e.length;o++){let s=e[o];if(s.empty())s.head.line>i&&(indentLine(this,s.head.line,t,!0),i=s.head.line,o==this.doc.sel.primIndex&&ensureCursorVisible(this));else{let r=s.from(),n=s.to(),l=Math.max(i,r.line);i=Math.min(this.lastLine(),n.line-(n.ch?0:1))+1;for(let e=l;e<i;++e)indentLine(this,e,t);let h=this.doc.sel.ranges;0==r.ch&&e.length==h.length&&h[o].from().ch>0&&replaceOneSelection(this.doc,o,new Range(r,h[o].to()),sel_dontScroll)}}})),getTokenAt:function(t,e){return takeToken(this,t,e)},getLineTokens:function(t,e){return takeToken(this,Pos(t),e,!0)},getTokenTypeAt:function(t){t=clipPos(this.doc,t);let e,i=getLineStyles(this,getLine(this.doc,t.line)),o=0,s=(i.length-1)/2,r=t.ch;if(0==r)e=i[2];else for(;;){let t=o+s>>1;if((t?i[2*t-1]:0)>=r)s=t;else{if(!(i[2*t+1]<r)){e=i[2*t+2];break}o=t+1}}let n=e?e.indexOf("overlay "):-1;return n<0?e:0==n?null:e.slice(0,n-1)},getModeAt:function(e){let i=this.doc.mode;return i.innerMode?t.innerMode(i,this.getTokenAt(e).state).mode:i},getHelper:function(t,e){return this.getHelpers(t,e)[0]},getHelpers:function(t,e){let o=[];if(!i.hasOwnProperty(e))return o;let s=i[e],r=this.getModeAt(t);if("string"==typeof r[e])s[r[e]]&&o.push(s[r[e]]);else if(r[e])for(let t=0;t<r[e].length;t++){let i=s[r[e][t]];i&&o.push(i)}else r.helperType&&s[r.helperType]?o.push(s[r.helperType]):s[r.name]&&o.push(s[r.name]);for(let t=0;t<s._global.length;t++){let e=s._global[t];e.pred(r,this)&&-1==indexOf(o,e.val)&&o.push(e.val)}return o},getStateAfter:function(t,e){let i=this.doc;return t=clipLine(i,null==t?i.first+i.size-1:t),getContextBefore(this,t+1,e).state},cursorCoords:function(t,e){let i,o=this.doc.sel.primary();return i=null==t?o.head:"object"==typeof t?clipPos(this.doc,t):t?o.from():o.to(),cursorCoords(this,i,e||"page")},charCoords:function(t,e){return charCoords(this,clipPos(this.doc,t),e||"page")},coordsChar:function(t,e){return t=fromCoordSystem(this,t,e||"page"),coordsChar(this,t.left,t.top)},lineAtHeight:function(t,e){return t=fromCoordSystem(this,{top:t,left:0},e||"page").top,lineAtHeight(this.doc,t+this.display.viewOffset)},heightAtLine:function(t,e,i){let o,s=!1;if("number"==typeof t){let e=this.doc.first+this.doc.size-1;t<this.doc.first?t=this.doc.first:t>e&&(t=e,s=!0),o=getLine(this.doc,t)}else o=t;return intoCoordSystem(this,o,{top:0,left:0},e||"page",i||s).top+(s?this.doc.height-heightAtLine(o):0)},defaultTextHeight:function(){return textHeight(this.display)},defaultCharWidth:function(){return charWidth(this.display)},getViewport:function(){return{from:this.display.viewFrom,to:this.display.viewTo}},addWidget:function(t,e,i,o,s){let r=this.display,n=(t=cursorCoords(this,clipPos(this.doc,t))).bottom,l=t.left;if(e.style.position="absolute",e.setAttribute("cm-ignore-events","true"),this.display.input.setUneditable(e),r.sizer.appendChild(e),"over"==o)n=t.top;else if("above"==o||"near"==o){let i=Math.max(r.wrapper.clientHeight,this.doc.height),s=Math.max(r.sizer.clientWidth,r.lineSpace.clientWidth);("above"==o||t.bottom+e.offsetHeight>i)&&t.top>e.offsetHeight?n=t.top-e.offsetHeight:t.bottom+e.offsetHeight<=i&&(n=t.bottom),l+e.offsetWidth>s&&(l=s-e.offsetWidth)}e.style.top=n+"px",e.style.left=e.style.right="","right"==s?(l=r.sizer.clientWidth-e.offsetWidth,e.style.right="0px"):("left"==s?l=0:"middle"==s&&(l=(r.sizer.clientWidth-e.offsetWidth)/2),e.style.left=l+"px"),i&&scrollIntoView(this,{left:l,top:n,right:l+e.offsetWidth,bottom:n+e.offsetHeight})},triggerOnKeyDown:methodOp(onKeyDown),triggerOnKeyPress:methodOp(onKeyPress),triggerOnKeyUp:onKeyUp,triggerOnMouseDown:methodOp(onMouseDown),execCommand:function(t){if(commands.hasOwnProperty(t))return commands[t].call(null,this)},triggerElectric:methodOp((function(t){triggerElectric(this,t)})),findPosH:function(t,e,i,o){let s=1;e<0&&(s=-1,e=-e);let r=clipPos(this.doc,t);for(let t=0;t<e&&(r=findPosH(this.doc,r,s,i,o),!r.hitSide);++t);return r},moveH:methodOp((function(t,e){this.extendSelectionsBy((i=>this.display.shift||this.doc.extend||i.empty()?findPosH(this.doc,i.head,t,e,this.options.rtlMoveVisually):t<0?i.from():i.to()),sel_move)})),deleteH:methodOp((function(t,e){let i=this.doc.sel,o=this.doc;i.somethingSelected()?o.replaceSelection("",null,"+delete"):deleteNearSelection(this,(i=>{let s=findPosH(o,i.head,t,e,!1);return t<0?{from:s,to:i.head}:{from:i.head,to:s}}))})),findPosV:function(t,e,i,o){let s=1,r=o;e<0&&(s=-1,e=-e);let n=clipPos(this.doc,t);for(let t=0;t<e;++t){let t=cursorCoords(this,n,"div");if(null==r?r=t.left:t.left=r,n=findPosV(this,t,s,i),n.hitSide)break}return n},moveV:methodOp((function(t,e){let i=this.doc,o=[],s=!this.display.shift&&!i.extend&&i.sel.somethingSelected();if(i.extendSelectionsBy((r=>{if(s)return t<0?r.from():r.to();let n=cursorCoords(this,r.head,"div");null!=r.goalColumn&&(n.left=r.goalColumn),o.push(n.left);let l=findPosV(this,n,t,e);return"page"==e&&r==i.sel.primary()&&addToScrollTop(this,charCoords(this,l,"div").top-n.top),l}),sel_move),o.length)for(let t=0;t<i.sel.ranges.length;t++)i.sel.ranges[t].goalColumn=o[t]})),findWordAt:function(t){let e=this.doc,i=getLine(e,t.line).text,o=t.ch,s=t.ch;if(i){let e=this.getHelper(t,"wordChars");"before"!=t.sticky&&s!=i.length||!o?++s:--o;let r=i.charAt(o),n=isWordChar(r,e)?t=>isWordChar(t,e):/\s/.test(r)?t=>/\s/.test(t):t=>!/\s/.test(t)&&!isWordChar(t);for(;o>0&&n(i.charAt(o-1));)--o;for(;s<i.length&&n(i.charAt(s));)++s}return new Range(Pos(t.line,o),Pos(t.line,s))},toggleOverwrite:function(t){null!=t&&t==this.state.overwrite||((this.state.overwrite=!this.state.overwrite)?addClass(this.display.cursorDiv,"CodeMirror-overwrite"):rmClass(this.display.cursorDiv,"CodeMirror-overwrite"),signal(this,"overwriteToggle",this,this.state.overwrite))},hasFocus:function(){return this.display.input.getField()==activeElt()},isReadOnly:function(){return!(!this.options.readOnly&&!this.doc.cantEdit)},scrollTo:methodOp((function(t,e){scrollToCoords(this,t,e)})),getScrollInfo:function(){let t=this.display.scroller;return{left:t.scrollLeft,top:t.scrollTop,height:t.scrollHeight-scrollGap(this)-this.display.barHeight,width:t.scrollWidth-scrollGap(this)-this.display.barWidth,clientHeight:displayHeight(this),clientWidth:displayWidth(this)}},scrollIntoView:methodOp((function(t,e){null==t?(t={from:this.doc.sel.primary().head,to:null},null==e&&(e=this.options.cursorScrollMargin)):"number"==typeof t?t={from:Pos(t,0),to:null}:null==t.from&&(t={from:t,to:null}),t.to||(t.to=t.from),t.margin=e||0,null!=t.from.line?scrollToRange(this,t):scrollToCoordsRange(this,t.from,t.to,t.margin)})),setSize:methodOp((function(t,e){let i=t=>"number"==typeof t||/^\d+$/.test(String(t))?t+"px":t;null!=t&&(this.display.wrapper.style.width=i(t)),null!=e&&(this.display.wrapper.style.height=i(e)),this.options.lineWrapping&&clearLineMeasurementCache(this);let o=this.display.viewFrom;this.doc.iter(o,this.display.viewTo,(t=>{if(t.widgets)for(let e=0;e<t.widgets.length;e++)if(t.widgets[e].noHScroll){regLineChange(this,o,"widget");break}++o})),this.curOp.forceUpdate=!0,signal(this,"refresh",this)})),operation:function(t){return runInOp(this,t)},startOperation:function(){return startOperation(this)},endOperation:function(){return endOperation(this)},refresh:methodOp((function(){let t=this.display.cachedTextHeight;regChange(this),this.curOp.forceUpdate=!0,clearCaches(this),scrollToCoords(this,this.doc.scrollLeft,this.doc.scrollTop),updateGutterSpace(this.display),(null==t||Math.abs(t-textHeight(this.display))>.5||this.options.lineWrapping)&&estimateLineHeights(this),signal(this,"refresh",this)})),swapDoc:methodOp((function(t){let e=this.doc;return e.cm=null,this.state.selectingText&&this.state.selectingText(),attachDoc(this,t),clearCaches(this),this.display.input.reset(),scrollToCoords(this,t.scrollLeft,t.scrollTop),this.curOp.forceScroll=!0,signalLater(this,"swapDoc",this,e),e})),phrase:function(t){let e=this.options.phrases;return e&&Object.prototype.hasOwnProperty.call(e,t)?e[t]:t},getInputField:function(){return this.display.input.getField()},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}},eventMixin(t),t.registerHelper=function(e,o,s){i.hasOwnProperty(e)||(i[e]=t[e]={_global:[]}),i[e][o]=s},t.registerGlobalHelper=function(e,o,s,r){t.registerHelper(e,o,r),i[e]._global.push({pred:s,val:r})}}function findPosH(t,e,i,o,s){let r=e,n=i,l=getLine(t,e.line),h=s&&"rtl"==t.direction?-i:i;function a(r){let n;if("codepoint"==o){let t=l.text.charCodeAt(e.ch+(i>0?0:-1));if(isNaN(t))n=null;else{let o=i>0?t>=55296&&t<56320:t>=56320&&t<57343;n=new Pos(e.line,Math.max(0,Math.min(l.text.length,e.ch+i*(o?2:1))),-i)}}else n=s?moveVisually(t.cm,l,e,i):moveLogically(l,e,i);if(null==n){if(r||!function(){let i=e.line+h;return!(i<t.first||i>=t.first+t.size)&&(e=new Pos(i,e.ch,e.sticky),l=getLine(t,i))}())return!1;e=endOfLine(s,t.cm,l,e.line,h)}else e=n;return!0}if("char"==o||"codepoint"==o)a();else if("column"==o)a(!0);else if("word"==o||"group"==o){let s=null,r="group"==o,n=t.cm&&t.cm.getHelper(e,"wordChars");for(let t=!0;!(i<0)||a(!t);t=!1){let o=l.text.charAt(e.ch)||"\n",h=isWordChar(o,n)?"w":r&&"\n"==o?"n":!r||/\s/.test(o)?null:"p";if(!r||t||h||(h="s"),s&&s!=h){i<0&&(i=1,a(),e.sticky="after");break}if(h&&(s=h),i>0&&!a(!t))break}}let d=skipAtomic(t,e,r,n,!0);return equalCursorPos(r,d)&&(d.hitSide=!0),d}function findPosV(t,e,i,o){let s,r,n=t.doc,l=e.left;if("page"==o){let o=Math.min(t.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),r=Math.max(o-.5*textHeight(t.display),3);s=(i>0?e.bottom:e.top)+i*r}else"line"==o&&(s=i>0?e.bottom+3:e.top-3);for(;r=coordsChar(t,l,s),r.outside;){if(i<0?s<=0:s>=n.height){r.hitSide=!0;break}s+=5*i}return r}