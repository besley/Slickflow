import{signalLater}from"../util/operation_group.js";import{restartBlink}from"../display/selection.js";import{isModifierKey,keyName,lookupKey}from"../input/keymap.js";import{eventInWidget}from"../measurement/widgets.js";import{ie,ie_version,mac,presto,gecko}from"../util/browser.js";import{activeElt,addClass,rmClass}from"../util/dom.js";import{e_preventDefault,off,on,signalDOMEvent}from"../util/event.js";import{hasCopyEvent}from"../util/feature_detection.js";import{Delayed,Pass}from"../util/misc.js";import{commands}from"./commands.js";function doHandleBinding(e,t,i){if("string"==typeof t&&!(t=commands[t]))return!1;e.display.input.ensurePolled();let n=e.display.shift,o=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),i&&(e.display.shift=!1),o=t(e)!=Pass}finally{e.display.shift=n,e.state.suppressEdits=!1}return o}function lookupKeyForEditor(e,t,i){for(let n=0;n<e.state.keyMaps.length;n++){let o=lookupKey(t,e.state.keyMaps[n],i,e);if(o)return o}return e.options.extraKeys&&lookupKey(t,e.options.extraKeys,i,e)||lookupKey(t,e.options.keyMap,i,e)}let stopSeq=new Delayed;export function dispatchKey(e,t,i,n){let o=e.state.keySeq;if(o){if(isModifierKey(t))return"handled";if(/\'$/.test(t)?e.state.keySeq=null:stopSeq.set(50,(()=>{e.state.keySeq==o&&(e.state.keySeq=null,e.display.input.reset())})),dispatchKeyInner(e,o+" "+t,i,n))return!0}return dispatchKeyInner(e,t,i,n)}function dispatchKeyInner(e,t,i,n){let o=lookupKeyForEditor(e,t,n);return"multi"==o&&(e.state.keySeq=t),"handled"==o&&signalLater(e,"keyHandled",e,t,i),"handled"!=o&&"multi"!=o||(e_preventDefault(i),restartBlink(e)),!!o}function handleKeyBinding(e,t){let i=keyName(t,!0);return!!i&&(t.shiftKey&&!e.state.keySeq?dispatchKey(e,"Shift-"+i,t,(t=>doHandleBinding(e,t,!0)))||dispatchKey(e,i,t,(t=>{if("string"==typeof t?/^go[A-Z]/.test(t):t.motion)return doHandleBinding(e,t)})):dispatchKey(e,i,t,(t=>doHandleBinding(e,t))))}function handleCharBinding(e,t,i){return dispatchKey(e,"'"+i+"'",t,(t=>doHandleBinding(e,t,!0)))}let lastStoppedKey=null;export function onKeyDown(e){let t=this;if(e.target&&e.target!=t.display.input.getField())return;if(t.curOp.focus=activeElt(),signalDOMEvent(t,e))return;ie&&ie_version<11&&27==e.keyCode&&(e.returnValue=!1);let i=e.keyCode;t.display.shift=16==i||e.shiftKey;let n=handleKeyBinding(t,e);presto&&(lastStoppedKey=n?i:null,n||88!=i||hasCopyEvent||!(mac?e.metaKey:e.ctrlKey)||t.replaceSelection("",null,"cut")),gecko&&!mac&&!n&&46==i&&e.shiftKey&&!e.ctrlKey&&document.execCommand&&document.execCommand("cut"),18!=i||/\bCodeMirror-crosshair\b/.test(t.display.lineDiv.className)||showCrossHair(t)}function showCrossHair(e){let t=e.display.lineDiv;function i(e){18!=e.keyCode&&e.altKey||(rmClass(t,"CodeMirror-crosshair"),off(document,"keyup",i),off(document,"mouseover",i))}addClass(t,"CodeMirror-crosshair"),on(document,"keyup",i),on(document,"mouseover",i)}export function onKeyUp(e){16==e.keyCode&&(this.doc.sel.shift=!1),signalDOMEvent(this,e)}export function onKeyPress(e){let t=this;if(e.target&&e.target!=t.display.input.getField())return;if(eventInWidget(t.display,e)||signalDOMEvent(t,e)||e.ctrlKey&&!e.altKey||mac&&e.metaKey)return;let i=e.keyCode,n=e.charCode;if(presto&&i==lastStoppedKey)return lastStoppedKey=null,void e_preventDefault(e);if(presto&&(!e.which||e.which<10)&&handleKeyBinding(t,e))return;let o=String.fromCharCode(null==n?i:n);"\b"!=o&&(handleCharBinding(t,e,o)||t.display.input.onKeyPress(e))}