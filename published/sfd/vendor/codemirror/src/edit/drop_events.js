import{drawSelectionCursor}from"../display/selection.js";import{operation}from"../display/operations.js";import{clipPos}from"../line/pos.js";import{posFromMouse}from"../measurement/position_measurement.js";import{eventInWidget}from"../measurement/widgets.js";import{makeChange,replaceRange}from"../model/changes.js";import{changeEnd}from"../model/change_measurement.js";import{simpleSelection}from"../model/selection.js";import{setSelectionNoUndo,setSelectionReplaceHistory}from"../model/selection_updates.js";import{ie,presto,safari}from"../util/browser.js";import{elt,removeChildrenAndAdd}from"../util/dom.js";import{e_preventDefault,e_stop,signalDOMEvent}from"../util/event.js";import{indexOf}from"../util/misc.js";let lastDrop=0;export function onDrop(e){let t=this;if(clearDragCursor(t),signalDOMEvent(t,e)||eventInWidget(t.display,e))return;e_preventDefault(e),ie&&(lastDrop=+new Date);let r=posFromMouse(t,e,!0),o=e.dataTransfer.files;if(r&&!t.isReadOnly())if(o&&o.length&&window.FileReader&&window.File){let e=o.length,i=Array(e),a=0;const s=()=>{++a==e&&operation(t,(()=>{r=clipPos(t.doc,r);let e={from:r,to:r,text:t.doc.splitLines(i.filter((e=>null!=e)).join(t.doc.lineSeparator())),origin:"paste"};makeChange(t.doc,e),setSelectionReplaceHistory(t.doc,simpleSelection(clipPos(t.doc,r),clipPos(t.doc,changeEnd(e))))}))()},l=(e,r)=>{if(t.options.allowDropFileTypes&&-1==indexOf(t.options.allowDropFileTypes,e.type))return void s();let o=new FileReader;o.onerror=()=>s(),o.onload=()=>{let e=o.result;/[\x00-\x08\x0e-\x1f]{2}/.test(e)||(i[r]=e),s()},o.readAsText(e)};for(let e=0;e<o.length;e++)l(o[e],e)}else{if(t.state.draggingText&&t.doc.sel.contains(r)>-1)return t.state.draggingText(e),void setTimeout((()=>t.display.input.focus()),20);try{let o=e.dataTransfer.getData("Text");if(o){let e;if(t.state.draggingText&&!t.state.draggingText.copy&&(e=t.listSelections()),setSelectionNoUndo(t.doc,simpleSelection(r,r)),e)for(let r=0;r<e.length;++r)replaceRange(t.doc,"",e[r].anchor,e[r].head,"drag");t.replaceSelection(o,"around","paste"),t.display.input.focus()}}catch(e){}}}export function onDragStart(e,t){if(ie&&(!e.state.draggingText||+new Date-lastDrop<100))e_stop(t);else if(!signalDOMEvent(e,t)&&!eventInWidget(e.display,t)&&(t.dataTransfer.setData("Text",e.getSelection()),t.dataTransfer.effectAllowed="copyMove",t.dataTransfer.setDragImage&&!safari)){let r=elt("img",null,null,"position: fixed; left: 0; top: 0;");r.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",presto&&(r.width=r.height=1,e.display.wrapper.appendChild(r),r._top=r.offsetTop),t.dataTransfer.setDragImage(r,0,0),presto&&r.parentNode.removeChild(r)}}export function onDragOver(e,t){let r=posFromMouse(e,t);if(!r)return;let o=document.createDocumentFragment();drawSelectionCursor(e,r,o),e.display.dragCursor||(e.display.dragCursor=elt("div",null,"CodeMirror-cursors CodeMirror-dragcursors"),e.display.lineSpace.insertBefore(e.display.dragCursor,e.display.cursorDiv)),removeChildrenAndAdd(e.display.dragCursor,o)}export function clearDragCursor(e){e.display.dragCursor&&(e.display.lineSpace.removeChild(e.display.dragCursor),e.display.dragCursor=null)}