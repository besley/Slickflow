import{delayBlurEvent,ensureFocus}from"../display/focus.js";import{operation}from"../display/operations.js";import{visibleLines}from"../display/update_lines.js";import{clipPos,cmp,maxPos,minPos,Pos}from"../line/pos.js";import{getLine,lineAtHeight}from"../line/utils_line.js";import{posFromMouse}from"../measurement/position_measurement.js";import{eventInWidget}from"../measurement/widgets.js";import{normalizeSelection,Range,Selection}from"../model/selection.js";import{extendRange,extendSelection,replaceOneSelection,setSelection}from"../model/selection_updates.js";import{captureRightClick,chromeOS,ie,ie_version,mac,webkit,safari}from"../util/browser.js";import{getOrder,getBidiPartAt}from"../util/bidi.js";import{activeElt}from"../util/dom.js";import{e_button,e_defaultPrevented,e_preventDefault,e_target,hasHandler,off,on,signal,signalDOMEvent}from"../util/event.js";import{dragAndDrop}from"../util/feature_detection.js";import{bind,countColumn,findColumn,sel_mouse}from"../util/misc.js";import{addModifierNames}from"../input/keymap.js";import{Pass}from"../util/misc.js";import{dispatchKey}from"./key_events.js";import{commands}from"./commands.js";const DOUBLECLICK_DELAY=400;class PastClick{constructor(e,t,n){this.time=e,this.pos=t,this.button=n}compare(e,t,n){return this.time+400>e&&0==cmp(t,this.pos)&&n==this.button}}let lastClick,lastDoubleClick;function clickRepeat(e,t){let n=+new Date;return lastDoubleClick&&lastDoubleClick.compare(n,e,t)?(lastClick=lastDoubleClick=null,"triple"):lastClick&&lastClick.compare(n,e,t)?(lastDoubleClick=new PastClick(n,e,t),lastClick=null,"double"):(lastClick=new PastClick(n,e,t),lastDoubleClick=null,"single")}export function onMouseDown(e){let t=this,n=t.display;if(signalDOMEvent(t,e)||n.activeTouch&&n.input.supportsTouch())return;if(n.input.ensurePolled(),n.shift=e.shiftKey,eventInWidget(n,e))return void(webkit||(n.scroller.draggable=!1,setTimeout((()=>n.scroller.draggable=!0),100)));if(clickInGutter(t,e))return;let o=posFromMouse(t,e),i=e_button(e),l=o?clickRepeat(o,i):"single";window.focus(),1==i&&t.state.selectingText&&t.state.selectingText(e),o&&handleMappedButton(t,i,o,l,e)||(1==i?o?leftButtonDown(t,o,l,e):e_target(e)==n.scroller&&e_preventDefault(e):2==i?(o&&extendSelection(t.doc,o),setTimeout((()=>n.input.focus()),20)):3==i&&(captureRightClick?t.display.input.onContextMenu(e):delayBlurEvent(t)))}function handleMappedButton(e,t,n,o,i){let l="Click";return"double"==o?l="Double"+l:"triple"==o&&(l="Triple"+l),l=(1==t?"Left":2==t?"Middle":"Right")+l,dispatchKey(e,addModifierNames(l,i),i,(t=>{if("string"==typeof t&&(t=commands[t]),!t)return!1;let o=!1;try{e.isReadOnly()&&(e.state.suppressEdits=!0),o=t(e,n)!=Pass}finally{e.state.suppressEdits=!1}return o}))}function configureMouse(e,t,n){let o=e.getOption("configureMouse"),i=o?o(e,t,n):{};if(null==i.unit){let e=chromeOS?n.shiftKey&&n.metaKey:n.altKey;i.unit=e?"rectangle":"single"==t?"char":"double"==t?"word":"line"}return(null==i.extend||e.doc.extend)&&(i.extend=e.doc.extend||n.shiftKey),null==i.addNew&&(i.addNew=mac?n.metaKey:n.ctrlKey),null==i.moveOnDrag&&(i.moveOnDrag=!(mac?n.altKey:n.ctrlKey)),i}function leftButtonDown(e,t,n,o){ie?setTimeout(bind(ensureFocus,e),0):e.curOp.focus=activeElt();let i,l=configureMouse(e,n,o),r=e.doc.sel;e.options.dragDrop&&dragAndDrop&&!e.isReadOnly()&&"single"==n&&(i=r.contains(t))>-1&&(cmp((i=r.ranges[i]).from(),t)<0||t.xRel>0)&&(cmp(i.to(),t)>0||t.xRel<0)?leftButtonStartDrag(e,o,t,l):leftButtonSelect(e,o,t,l)}function leftButtonStartDrag(e,t,n,o){let i=e.display,l=!1,r=operation(e,(t=>{webkit&&(i.scroller.draggable=!1),e.state.draggingText=!1,e.state.delayingBlurEvent&&(e.hasFocus()?e.state.delayingBlurEvent=!1:delayBlurEvent(e)),off(i.wrapper.ownerDocument,"mouseup",r),off(i.wrapper.ownerDocument,"mousemove",s),off(i.scroller,"dragstart",a),off(i.scroller,"drop",r),l||(e_preventDefault(t),o.addNew||extendSelection(e.doc,n,null,null,o.extend),webkit&&!safari||ie&&9==ie_version?setTimeout((()=>{i.wrapper.ownerDocument.body.focus({preventScroll:!0}),i.input.focus()}),20):i.input.focus())})),s=function(e){l=l||Math.abs(t.clientX-e.clientX)+Math.abs(t.clientY-e.clientY)>=10},a=()=>l=!0;webkit&&(i.scroller.draggable=!0),e.state.draggingText=r,r.copy=!o.moveOnDrag,on(i.wrapper.ownerDocument,"mouseup",r),on(i.wrapper.ownerDocument,"mousemove",s),on(i.scroller,"dragstart",a),on(i.scroller,"drop",r),e.state.delayingBlurEvent=!0,setTimeout((()=>i.input.focus()),20),i.scroller.dragDrop&&i.scroller.dragDrop()}function rangeForUnit(e,t,n){if("char"==n)return new Range(t,t);if("word"==n)return e.findWordAt(t);if("line"==n)return new Range(Pos(t.line,0),clipPos(e.doc,Pos(t.line+1,0)));let o=n(e,t);return new Range(o.from,o.to)}function leftButtonSelect(e,t,n,o){ie&&delayBlurEvent(e);let i=e.display,l=e.doc;e_preventDefault(t);let r,s,a=l.sel,c=a.ranges;if(o.addNew&&!o.extend?(s=l.sel.contains(n),r=s>-1?c[s]:new Range(n,n)):(r=l.sel.primary(),s=l.sel.primIndex),"rectangle"==o.unit)o.addNew||(r=new Range(n,n)),n=posFromMouse(e,t,!0,!0),s=-1;else{let t=rangeForUnit(e,n,o.unit);r=o.extend?extendRange(r,t.anchor,t.head,o.extend):t}o.addNew?-1==s?(s=c.length,setSelection(l,normalizeSelection(e,c.concat([r]),s),{scroll:!1,origin:"*mouse"})):c.length>1&&c[s].empty()&&"char"==o.unit&&!o.extend?(setSelection(l,normalizeSelection(e,c.slice(0,s).concat(c.slice(s+1)),0),{scroll:!1,origin:"*mouse"}),a=l.sel):replaceOneSelection(l,s,r,sel_mouse):(s=0,setSelection(l,new Selection([r],0),sel_mouse),a=l.sel);let u=n,p=i.wrapper.getBoundingClientRect(),m=0;function d(t){let c=++m,f=posFromMouse(e,t,!0,"rectangle"==o.unit);if(f)if(0!=cmp(f,u)){e.curOp.focus=activeElt(),function(t){if(0!=cmp(u,t))if(u=t,"rectangle"==o.unit){let o=[],i=e.options.tabSize,r=countColumn(getLine(l,n.line).text,n.ch,i),c=countColumn(getLine(l,t.line).text,t.ch,i),u=Math.min(r,c),p=Math.max(r,c);for(let r=Math.min(n.line,t.line),s=Math.min(e.lastLine(),Math.max(n.line,t.line));r<=s;r++){let e=getLine(l,r).text,t=findColumn(e,u,i);u==p?o.push(new Range(Pos(r,t),Pos(r,t))):e.length>t&&o.push(new Range(Pos(r,t),Pos(r,findColumn(e,p,i))))}o.length||o.push(new Range(n,n)),setSelection(l,normalizeSelection(e,a.ranges.slice(0,s).concat(o),s),{origin:"*mouse",scroll:!1}),e.scrollIntoView(t)}else{let n,i=r,c=rangeForUnit(e,t,o.unit),u=i.anchor;cmp(c.anchor,u)>0?(n=c.head,u=minPos(i.from(),c.anchor)):(n=c.anchor,u=maxPos(i.to(),c.head));let p=a.ranges.slice(0);p[s]=bidiSimplify(e,new Range(clipPos(l,u),n)),setSelection(l,normalizeSelection(e,p,s),sel_mouse)}}(f);let p=visibleLines(i,l);(f.line>=p.to||f.line<p.from)&&setTimeout(operation(e,(()=>{m==c&&d(t)})),150)}else{let n=t.clientY<p.top?-20:t.clientY>p.bottom?20:0;n&&setTimeout(operation(e,(()=>{m==c&&(i.scroller.scrollTop+=n,d(t))})),50)}}function f(t){e.state.selectingText=!1,m=1/0,t&&(e_preventDefault(t),i.input.focus()),off(i.wrapper.ownerDocument,"mousemove",g),off(i.wrapper.ownerDocument,"mouseup",h),l.history.lastSelOrigin=null}let g=operation(e,(e=>{0!==e.buttons&&e_button(e)?d(e):f(e)})),h=operation(e,f);e.state.selectingText=h,on(i.wrapper.ownerDocument,"mousemove",g),on(i.wrapper.ownerDocument,"mouseup",h)}function bidiSimplify(e,t){let{anchor:n,head:o}=t,i=getLine(e.doc,n.line);if(0==cmp(n,o)&&n.sticky==o.sticky)return t;let l=getOrder(i);if(!l)return t;let r=getBidiPartAt(l,n.ch,n.sticky),s=l[r];if(s.from!=n.ch&&s.to!=n.ch)return t;let a,c=r+(s.from==n.ch==(1!=s.level)?0:1);if(0==c||c==l.length)return t;if(o.line!=n.line)a=(o.line-n.line)*("ltr"==e.doc.direction?1:-1)>0;else{let e=getBidiPartAt(l,o.ch,o.sticky),t=e-r||(o.ch-n.ch)*(1==s.level?-1:1);a=e==c-1||e==c?t<0:t>0}let u=l[c+(a?-1:0)],p=a==(1==u.level),m=p?u.from:u.to,d=p?"after":"before";return n.ch==m&&n.sticky==d?t:new Range(new Pos(n.line,m,d),o)}function gutterEvent(e,t,n,o){let i,l;if(t.touches)i=t.touches[0].clientX,l=t.touches[0].clientY;else try{i=t.clientX,l=t.clientY}catch(t){return!1}if(i>=Math.floor(e.display.gutters.getBoundingClientRect().right))return!1;o&&e_preventDefault(t);let r=e.display,s=r.lineDiv.getBoundingClientRect();if(l>s.bottom||!hasHandler(e,n))return e_defaultPrevented(t);l-=s.top-r.viewOffset;for(let o=0;o<e.display.gutterSpecs.length;++o){let s=r.gutters.childNodes[o];if(s&&s.getBoundingClientRect().right>=i){let i=lineAtHeight(e.doc,l),r=e.display.gutterSpecs[o];return signal(e,n,e,i,r.className,t),e_defaultPrevented(t)}}}export function clickInGutter(e,t){return gutterEvent(e,t,"gutterClick",!0)}export function onContextMenu(e,t){eventInWidget(e.display,t)||contextMenuInGutter(e,t)||signalDOMEvent(e,t,"contextmenu")||captureRightClick||e.display.input.onContextMenu(t)}function contextMenuInGutter(e,t){return!!hasHandler(e,"gutterContextMenu")&&gutterEvent(e,t,"gutterContextMenu",!1)}